import{B as e,r as l,o as t,c as a,w as o,h as r,i,g as s,t as n,e as d,F as u,l as c,C as p}from"./vendor.6c36e4e7.js";import{S as f,c as b}from"./index.236993a1.js";import{_ as m}from"./index.93837071.js";const h={props:["viewVisible","jobRecordData"],watch:{jobRecordData:{immediate:!0,handler(e){for(let l=0;l<e.length;l++){let t=e[l].atomVOList;for(let e=0;e<t.length;e++){let l=t[e];this.checkList[l.id]=[],this.allAtom[l.id]=l}}}},viewVisible:{immediate:!0,handler(e){console.log("viewVisible"+e)}}},setup(){const l=e(!1),t=e([]),a=e(!1),o=e({}),r=e({}),i=e(),s=e([]),n=e([]),d=e(),u=e=>JSON.parse(e),c=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const l=16*Math.random()|0;return("x"===e?l:3&l|8).toString(16)}));return{allAtom:r,selectAtom:n,startRestoreButton:l,selectDataSourceId:i,checkList:o,restoreViewVisible:a,dataSources:t,filterJobResult:(e,l)=>l.jobResult===e,startRestore:()=>{if(console.log(i),console.log(n),void 0===i.value)return void p.error("请选择目标数据源");l.value=!0;let e=c();d.value=new WebSocket(f+"/restore/"+e),d.value.onopen=function(l){console.log("连接成功"),d.value.send(JSON.stringify({msgId:e,data:{dataSouceId:i.value,atom:n.value}}))},d.value.onmessage=function(e){let l=JSON.parse(e.data);l.result?n.value[l.key-1].status="success":n.value[l.key-1].status="exception",n.value[l.key-1].percentage=100,n.value[l.key-1].log=l.log},d.value.onError=function(e){p.error("websocket连接失败:"+e)}},jsonStrtoArray:u,byteToStr:e=>{if(!e)return"";var l=1024;return e<l?e+"B":e<Math.pow(l,2)?(e/l).toFixed(2)+"KB":e<Math.pow(l,3)?(e/Math.pow(l,2)).toFixed(2)+"MB":e<Math.pow(l,4)?(e/Math.pow(l,3)).toFixed(2)+"G":(e/Math.pow(l,4)).toFixed(2)+"T"},getStateTag:e=>"NORMAL"===e?"info":"RUNNING"===e?"warning":"SUCCESS"===e?"success":"FAIL"===e?"danger":"",filterJobRecordResult:(e,l)=>l.result===e,handleSelectionChange:(e,l)=>{let t=!0,a=l.id;for(let r=0;r<e.length;r++){let l=e[r],i=l.id;i==a&&(t=!1);let s=u(l.tables);o.value[i]=s}t&&(o.value[a]=[]),s.value=e},jumpRestorePage:()=>{n.value=[],b().then((e=>{"0"===e.code?t.value=e.result:p.error("获取所有数据源列表失败:"+e.message)}));let e=1;for(let l in o.value){let t=o.value[l];if(t.length>0)for(let a in t){let o="";for(let e in r.value)if(l==r.value[e].id){o=r.value[e].dataBase;break}n.value.push({key:e,id:l,dataBase:o,table:t[a],percentage:0,status:"",result:0,log:""}),e++}}a.value=!0},handleSelectionAll:e=>{if(0===e.length)console.log("清空全选");else for(let l=0;l<e.length;l++){let t=e[l],a=t.id,r=u(t.tables);o.value[a]=r}s.value=e}}}},g={style:{height:"300px",width:"300px",overflow:"auto"}},v={style:{height:"500px","white-space":"pre-line",overflow:"auto"}},x=s("span",{slot:"label"},[s("i",{class:"el-icon-coin",style:{color:"red"}},"* "),i(" 目标数据源 ")],-1),w={style:{height:"500px","white-space":"pre-line",overflow:"auto"}};var S=m(h,[["render",function(e,p,f,b,m,h){const S=l("el-button"),y=l("el-table-column"),_=l("el-tag"),V=l("el-checkbox"),k=l("el-checkbox-group"),R=l("el-popover"),j=l("el-table"),A=l("el-option"),C=l("el-select"),T=l("el-form-item"),B=l("el-progress"),I=l("el-drawer");return t(),a(I,{title:"job执行记录","model-value":f.viewVisible,"show-close":!0,size:"80%"},{default:o((()=>[r(S,{icon:"el-icon-refresh",type:"primary",style:{float:"right",margin:"10px"},size:"small",onClick:b.jumpRestorePage},{default:o((()=>[i("选中恢复")])),_:1},8,["onClick"]),r(j,{data:f.jobRecordData,border:"",class:"table",ref:"multipleTable","header-cell-class-name":"table-header"},{default:o((()=>[r(y,{type:"expand"},{default:o((l=>[s("div",null,[r(j,{data:l.row.atomVOList,border:e.childBorder,onSelectAll:b.handleSelectionAll,onSelect:b.handleSelectionChange},{default:o((()=>[r(y,{type:"selection",width:"55"}),r(y,{label:"数据库",prop:"dataBase"}),r(y,{prop:"result",label:"备份结果",filters:[{text:"成功",value:"SUCCESS"},{text:"失败",value:"FAIL"}],"filter-method":b.filterJobRecordResult,"filter-placement":"bottom-end"},{default:o((e=>[r(_,{type:b.getStateTag(e.row.result)},{default:o((()=>[i(n(e.row.result),1)])),_:2},1032,["type"])])),_:1},8,["filter-method"]),r(y,{label:"备份路径","min-width":"200",prop:"filePath"}),r(y,{label:"备份大小"},{default:o((e=>[s("span",null,n(b.byteToStr(e.row.fileSize)),1)])),_:1}),r(y,{label:"开始时间","min-width":"100",prop:"startTime"}),r(y,{label:"结束时间","min-width":"100",prop:"endTime"}),r(y,{label:"备份表",align:"center"},{default:o((e=>[r(R,{placement:"left",width:300},{reference:o((()=>[r(S,{slot:"reference",icon:"el-icon-more"})])),default:o((()=>[s("div",g,[r(k,{modelValue:b.checkList[e.row.id],"onUpdate:modelValue":l=>b.checkList[e.row.id]=l},{default:o((()=>[(t(!0),d(u,null,c(b.jsonStrtoArray(e.row.tables),(e=>(t(),a(V,{style:{display:"block","padding-top":"10px"},label:e},null,8,["label"])))),256))])),_:2},1032,["modelValue","onUpdate:modelValue"])])])),_:2},1024)])),_:1}),r(y,{label:"查看日志",align:"center"},{default:o((e=>[r(R,{placement:"left",width:480},{reference:o((()=>[r(S,{slot:"reference",icon:"el-icon-view"})])),default:o((()=>[s("div",v,n(e.row.log),1)])),_:2},1024)])),_:1})])),_:2},1032,["data","border","onSelectAll","onSelect"])])])),_:1}),r(y,{prop:"id",label:"ID",align:"center"}),r(y,{prop:"jobResult",label:"执行状态",filters:[{text:"成功",value:"SUCCESS"},{text:"失败",value:"FAIL"}],"filter-method":b.filterJobResult,"filter-placement":"bottom-end"},{default:o((e=>[r(_,{type:b.getStateTag(e.row.jobResult)},{default:o((()=>[i(n(e.row.jobResult),1)])),_:2},1032,["type"])])),_:1},8,["filter-method"]),r(y,{prop:"jobStartTime",label:"开始时间"}),r(y,{prop:"jobEndTime",label:"结束时间"})])),_:1},8,["data"]),r(I,{title:"恢复页面",modelValue:b.restoreViewVisible,"onUpdate:modelValue":p[1]||(p[1]=e=>b.restoreViewVisible=e),"show-close":!0,size:"50%","append-to-body":!0},{default:o((()=>[r(T,{style:{float:"right","margin-right":"4em"}},{default:o((()=>[x,r(C,{modelValue:b.selectDataSourceId,"onUpdate:modelValue":p[0]||(p[0]=e=>b.selectDataSourceId=e),placeholder:"选择目标数据源",filterable:""},{default:o((()=>[(t(!0),d(u,null,c(b.dataSources,(e=>(t(),a(A,{key:e.id,label:e.sourceName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),r(S,{type:"primary",onClick:b.startRestore,style:{"margin-left":"1em"},disabled:b.startRestoreButton},{default:o((()=>[i("开始")])),_:1},8,["onClick","disabled"])])),_:1}),r(j,{data:b.selectAtom,border:"",class:"table",ref:"multipleTable","header-cell-class-name":"table-header","max-height":"600"},{default:o((()=>[r(y,{prop:"key",label:"序列",align:"center"}),r(y,{prop:"dataBase",label:"数据库","show-overflow-tooltip":""}),r(y,{prop:"table",label:"表","show-overflow-tooltip":""}),r(y,{prop:"percentage",label:"进度"},{default:o((e=>[r(B,{percentage:e.row.percentage,status:e.row.status},null,8,["percentage","status"])])),_:1}),r(y,{label:"查看日志",align:"center"},{default:o((e=>[r(R,{placement:"left",width:500},{reference:o((()=>[r(S,{slot:"reference",icon:"el-icon-view"})])),default:o((()=>[s("div",w,n(e.row.log),1)])),_:2},1024)])),_:1})])),_:1},8,["data"])])),_:1},8,["modelValue"])])),_:1},8,["model-value"])}]]);export{S as J};
