import{J as e}from"./Job.9a181a6a.js";import{B as l,E as a,r as t,o,e as r,g as d,h as u,w as n,i as s,F as i,l as c,c as b,t as m,f as p,C as f,L as h,p as v,j as g}from"./vendor.6c36e4e7.js";import{f as y,A as V,c as j,B as S,g as x,d as _,E as C,e as w,L as N}from"./index.236993a1.js";import{_ as k}from"./index.a811416a.js";const E={name:"backUpTable",components:{Job:e},setup(){const e=l(""),t=l(),o=l(["information_schema","mysql","performance_schema","sys"]),r=l([]),d=l([]),u=l([]),n=l([]),s=l([]),i=l(!1),c=l(0),b=l(!1),m=l(!1),p=l([]),v=l([]),g=l(0),k=l(!1),E=a({jobName:"",jobState:"",dataSourceId:"",page:1,size:10,jobType:1}),D=a({jobName:"",jobDescribe:"",jobType:1,dataSourceId:"",cronExpression:"",jobPolicy:""}),T=a({id:0,jobName:"",jobDescribe:"",jobType:1,dataSourceId:"",cronExpression:"",jobPolicy:""}),U=()=>{j().then((e=>{"0"===e.code?d.value=e.result:(console.log("获取所有数据源列表失败"),f.error("获取所有数据源列表失败:"+e.message))}))},B=()=>{U(),S(E).then((e=>{p.value=e.result.records,g.value=e.result.total||50}))};B();return{timer:e,cronExpression:t,lastRunTimeData:r,allDataBase:n,dataBase:u,dataSources:d,visible:i,deleteId:c,query:E,tableData:p,jobRecordData:v,pageTotal:g,editVisible:b,viewVisible:m,addVisible:k,form:T,addForm:D,saveEdit:()=>{T.cronExpression=t.value;let e={},l=[],a=[];for(let t=1;t<=s.value.length;t++){let e=s.value[t-1];u.value.includes(t)?l.push(e):a.push(e)}e.backUpDataBase=l,e.excludeDataBase=a,T.jobPolicy=JSON.stringify(e),y(T).then((e=>{"0"===e.code?(f.success("更新备份任务成功"),B()):f.error("更新备份任务失败"+e.message)})),b.value=!1},lastRunTime:()=>{let e=t.value;N(e).then((e=>{"0"===e.code?r.value=e.result:f.error("获取最近运行时间失败："+e.message)}))},selectDataSource:e=>{V(e).then((e=>{if("0"===e.code){s.value=e.result;for(let e=1;e<=s.value.length;e++){let l=s.value[e-1];n.value.push({key:e,label:l,disabled:!!o.value.includes(l)})}}else f.error("获取所有数据源下所有数据库失败:"+e.message)}))},allDataSource:U,handleEnable:(e,l)=>{h.confirm("是否"+("OFF"===l.jobEnable?"开启":"关闭")+"这个任务",{confirmButtonText:"OK",cancelButtonText:"Cancel",type:"warning"}).then((()=>{C(l.id).then((e=>{"0"===e.code?(f.success("操作成功"),B()):f.error("操作失败"+e.message)}))})).catch((()=>{}))},filterEnable:(e,l)=>l.jobEnable===e,handleAdd:()=>{k.value=!0,U()},handleSearch:()=>{E.page_num=1,B()},handlePageChange:e=>{E.page=e,B()},handleDelete:(e,l)=>{h.confirm("是否删除这个任务",{confirmButtonText:"OK",cancelButtonText:"Cancel",type:"warning"}).then((()=>{x(l.id).then((e=>{"0"===e.code?(f.success("删除成功"),B()):f.error("删除失败"+e.message)}))})).catch((()=>{}))},handleEdit:(e,l)=>{n.value=[],u.value=[],console.log(n.value),console.log(u.value),U(),Object.keys(T).forEach((e=>{T[e]=l[e]})),t.value=l.cronExpression;let a=JSON.parse(T.jobPolicy),r=[];r=a.backUpDataBase,V(l.dataSourceId).then((e=>{if("0"===e.code){s.value=e.result;for(let e=1;e<=s.value.length;e++){let l=s.value[e-1];n.value.push({key:e,label:l,disabled:!!o.value.includes(l)}),r.includes(l)&&u.value.push(e)}}else f.error("获取所有数据源下所有数据库失败:"+e.message)})),b.value=!0},handleView:(l,a)=>{_(a.id).then((e=>{v.value=e.result})),e.value=(new Date).getTime(),m.value=!0},saveAdd:()=>{D.cronExpression=t.value;let e={},l=[],a=[];for(let t=1;t<=s.value.length;t++){let e=s.value[t-1];u.value.includes(t)?l.push(e):a.push(e)}e.backUpDataBase=l,e.excludeDataBase=a,D.jobPolicy=JSON.stringify(e),w(D).then((e=>{"0"===e.code?(f.success("创建备份任务成功"),B()):f.error("创建备份任务失败"+e.message)})),k.value=!1},filterType:(e,l)=>l.jobType===e,filterState:(e,l)=>l.jobState===e,getStateTag:e=>"NORMAL"===e||"OFF"===e?"info":"RUNNING"===e?"warning":"SUCCESS"===e||"ON"===e?"success":"FAIL"===e?"danger":"",filterJobResult:(e,l)=>l.jobResult===e,filterJobRecordResult:(e,l)=>l.result===e,jsonStrtoArray:e=>JSON.parse(e),byteToStr:e=>{if(!e)return"";var l=1024;return e<l?e+"B":e<Math.pow(l,2)?(e/l).toFixed(2)+"KB":e<Math.pow(l,3)?(e/Math.pow(l,2)).toFixed(2)+"MB":e<Math.pow(l,4)?(e/Math.pow(l,3)).toFixed(2)+"G":(e/Math.pow(l,4)).toFixed(2)+"T"}}}},D=e=>(v("data-v-a232f95a"),e=e(),g(),e),T={class:"crumbs"},U=D((()=>d("i",{class:"el-icon-lx-cascades"},null,-1))),B={class:"container"},F={class:"handle-box"},I={class:"pagination"},R=D((()=>d("br",null,null,-1))),O=D((()=>d("span",null,"最近运行时间",-1))),M={class:"dialog-footer"},q=D((()=>d("br",null,null,-1))),A=D((()=>d("span",null,"最近运行时间",-1))),J={class:"dialog-footer"};var L=k(E,[["render",function(e,l,a,f,h,v){const g=t("el-breadcrumb-item"),y=t("el-breadcrumb"),V=t("el-option"),j=t("el-select"),S=t("el-input"),x=t("el-button"),_=t("el-table-column"),C=t("el-tag"),w=t("el-button-group"),N=t("el-table"),k=t("el-pagination"),E=t("el-form-item"),D=t("el-transfer"),L=t("el-tooltip"),z=t("el-form"),P=t("el-dialog"),G=t("Job");return o(),r("div",null,[d("div",T,[u(y,{separator:"/"},{default:n((()=>[u(g,null,{default:n((()=>[U,s("周期性备份任务 ")])),_:1})])),_:1})]),d("div",B,[d("div",F,[u(j,{modelValue:f.query.dataSourceId,"onUpdate:modelValue":l[0]||(l[0]=e=>f.query.dataSourceId=e),placeholder:"数据源",filterable:"",clearable:"",class:"handle-input mr10"},{default:n((()=>[(o(!0),r(i,null,c(f.dataSources,(e=>(o(),b(V,{key:e.id,label:e.sourceName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),u(S,{modelValue:f.query.jobName,"onUpdate:modelValue":l[1]||(l[1]=e=>f.query.jobName=e),placeholder:"任务名称",class:"handle-input mr10"},null,8,["modelValue"]),u(j,{modelValue:f.query.jobState,"onUpdate:modelValue":l[2]||(l[2]=e=>f.query.jobState=e),placeholder:"最近一次任务状态",filterable:"",clearable:"",class:"handle-input mr10"},{default:n((()=>[u(V,{key:"NORMAL",label:"正常",value:"NORMAL"}),u(V,{key:"RUNNING",label:"运行中",value:"RUNNING"}),u(V,{key:"SUCCESS",label:"成功",value:"SUCCESS"}),u(V,{key:"FAIL",label:"失败",value:"FAIL"})])),_:1},8,["modelValue"]),u(x,{type:"primary",icon:"el-icon-search",onClick:f.handleSearch},{default:n((()=>[s("搜索")])),_:1},8,["onClick"]),u(x,{type:"primary",icon:"el-icon-plus",onClick:f.handleAdd},{default:n((()=>[s("新增")])),_:1},8,["onClick"])]),u(N,{data:f.tableData,border:"",class:"table",ref:"multipleTable","header-cell-class-name":"table-header"},{default:n((()=>[u(_,{prop:"id",label:"ID",align:"center"}),u(_,{prop:"dataSourceName",label:"数据源"}),u(_,{prop:"jobName",label:"任务名称","show-overflow-tooltip":""}),u(_,{prop:"jobDescribe",label:"描述",width:"150","show-overflow-tooltip":""}),u(_,{prop:"jobState",label:"最近一次任务状态",filters:[{text:"正常",value:"NORMAL"},{text:"运行中",value:"RUNNING"},{text:"成功",value:"SUCCESS"},{text:"失败",value:"FAIL"}],"filter-method":f.filterState,"filter-placement":"bottom-end"},{default:n((e=>[u(C,{type:f.getStateTag(e.row.jobState)},{default:n((()=>[s(m(e.row.jobState),1)])),_:2},1032,["type"])])),_:1},8,["filter-method"]),u(_,{prop:"jobEnable",label:"任务运行状态",filters:[{text:"关闭",value:"OFF"},{text:"开启",value:"ON"}],"filter-method":f.filterEnable,"filter-placement":"bottom-end"},{default:n((e=>[u(C,{type:f.getStateTag(e.row.jobEnable)},{default:n((()=>[s(m(e.row.jobEnable),1)])),_:2},1032,["type"])])),_:1},8,["filter-method"]),u(_,{prop:"cronExpression",label:"cron表达式"}),u(_,{prop:"executeTime",label:"最近一次执行时间"}),u(_,{prop:"lastTime",label:"上次执行时间"}),u(_,{prop:"nextTime",label:"下次执行时间"}),u(_,{label:"操作",align:"center","min-width":"120"},{default:n((e=>[u(w,{class:"ml-4"},{default:n((()=>[u(x,{icon:"el-icon-view",size:"small",onClick:l=>f.handleView(e.$index,e.row)},null,8,["onClick"]),u(x,{icon:"el-icon-open",size:"small",onClick:l=>f.handleEnable(e.$index,e.row)},null,8,["onClick"]),u(x,{icon:"el-icon-edit",size:"small",onClick:l=>f.handleEdit(e.$index,e.row)},null,8,["onClick"]),u(x,{icon:"el-icon-delete",class:"red",size:"small",onClick:l=>f.handleDelete(e.$index,e.row)},null,8,["onClick"])])),_:2},1024)])),_:1})])),_:1},8,["data"]),d("div",I,[u(k,{background:"",layout:"total, prev, pager, next","current-page":f.query.page,"page-size":f.query.size,total:f.pageTotal,onCurrentChange:f.handlePageChange},null,8,["current-page","page-size","total","onCurrentChange"])])]),p(" 新增job任务 "),u(P,{title:"新增周期性性任务",modelValue:f.addVisible,"onUpdate:modelValue":l[9]||(l[9]=e=>f.addVisible=e),width:"50%"},{footer:n((()=>[d("span",M,[u(x,{onClick:l[8]||(l[8]=e=>f.addVisible=!1)},{default:n((()=>[s("取 消")])),_:1}),u(x,{type:"primary",onClick:f.saveAdd},{default:n((()=>[s("确 定")])),_:1},8,["onClick"])])])),default:n((()=>[u(z,{"label-width":"100px"},{default:n((()=>[u(E,{label:"任务名称",required:!0},{default:n((()=>[u(S,{modelValue:f.addForm.jobName,"onUpdate:modelValue":l[3]||(l[3]=e=>f.addForm.jobName=e)},null,8,["modelValue"])])),_:1}),u(E,{label:"数据源",required:!0},{default:n((()=>[u(j,{modelValue:f.addForm.dataSourceId,"onUpdate:modelValue":l[4]||(l[4]=e=>f.addForm.dataSourceId=e),placeholder:"请选择",filterable:"",onChange:f.selectDataSource},{default:n((()=>[(o(!0),r(i,null,c(f.dataSources,(e=>(o(),b(V,{key:e.id,label:e.sourceName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","onChange"])])),_:1}),u(E,{label:"数据库"},{default:n((()=>[u(D,{modelValue:f.dataBase,"onUpdate:modelValue":l[5]||(l[5]=e=>f.dataBase=e),data:f.allDataBase,titles:["所有数据库","要备份的数据库"],filterable:""},null,8,["modelValue","data"])])),_:1}),u(E,{label:"cron表达式"},{default:n((()=>[u(S,{modelValue:f.cronExpression,"onUpdate:modelValue":l[6]||(l[6]=e=>f.cronExpression=e)},{suffix:n((()=>[u(L,{placement:"right"},{content:n((()=>[(o(!0),r(i,null,c(f.lastRunTimeData,(e=>(o(),r("span",null,[s(m(e),1),R])))),256))])),default:n((()=>[u(x,{type:"primary",onMouseover:f.lastRunTime,style:{position:"relative",left:"5px"}},{default:n((()=>[O])),_:1},8,["onMouseover"])])),_:1})])),_:1},8,["modelValue"])])),_:1}),u(E,{label:"描述"},{default:n((()=>[u(S,{modelValue:f.addForm.jobDescribe,"onUpdate:modelValue":l[7]||(l[7]=e=>f.addForm.jobDescribe=e),type:"textarea"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),p(" 编辑job任务 "),u(P,{title:"编辑任务",modelValue:f.editVisible,"onUpdate:modelValue":l[16]||(l[16]=e=>f.editVisible=e),width:"50%"},{footer:n((()=>[d("span",J,[u(x,{onClick:l[15]||(l[15]=e=>f.editVisible=!1)},{default:n((()=>[s("取 消")])),_:1}),u(x,{type:"primary",onClick:f.saveEdit},{default:n((()=>[s("确 定")])),_:1},8,["onClick"])])])),default:n((()=>[u(z,{"label-width":"100px"},{default:n((()=>[u(E,{label:"任务名称",required:!0},{default:n((()=>[u(S,{modelValue:f.form.jobName,"onUpdate:modelValue":l[10]||(l[10]=e=>f.form.jobName=e)},null,8,["modelValue"])])),_:1}),u(E,{label:"数据源",required:!0},{default:n((()=>[u(j,{modelValue:f.form.dataSourceId,"onUpdate:modelValue":l[11]||(l[11]=e=>f.form.dataSourceId=e),placeholder:"请选择",filterable:"",onChange:f.selectDataSource},{default:n((()=>[(o(!0),r(i,null,c(f.dataSources,(e=>(o(),b(V,{key:e.id,label:e.sourceName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","onChange"])])),_:1}),u(E,{label:"数据库"},{default:n((()=>[u(D,{modelValue:f.dataBase,"onUpdate:modelValue":l[12]||(l[12]=e=>f.dataBase=e),data:f.allDataBase,titles:["所有数据库","要备份的数据库"],filterable:""},null,8,["modelValue","data"])])),_:1}),u(E,{label:"cron表达式"},{default:n((()=>[u(S,{modelValue:f.cronExpression,"onUpdate:modelValue":l[13]||(l[13]=e=>f.cronExpression=e)},{suffix:n((()=>[u(L,{placement:"right"},{content:n((()=>[(o(!0),r(i,null,c(f.lastRunTimeData,(e=>(o(),r("span",null,[s(m(e),1),q])))),256))])),default:n((()=>[u(x,{type:"primary",onMouseover:f.lastRunTime,style:{position:"relative",left:"5px"}},{default:n((()=>[A])),_:1},8,["onMouseover"])])),_:1})])),_:1},8,["modelValue"])])),_:1}),u(E,{label:"描述"},{default:n((()=>[u(S,{modelValue:f.form.jobDescribe,"onUpdate:modelValue":l[14]||(l[14]=e=>f.form.jobDescribe=e),type:"textarea"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),p(" job执行记录   "),(o(),b(G,{viewVisible:f.viewVisible,"job-record-data":f.jobRecordData,key:f.timer},null,8,["viewVisible","job-record-data"]))])}],["__scopeId","data-v-a232f95a"]]);export{L as default};
