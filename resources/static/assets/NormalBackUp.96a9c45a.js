import{B as e,E as a,r as l,o as t,e as o,g as r,h as d,w as u,i as s,F as i,l as n,c,t as b,f as m,C as p,L as f,p as h,j as v}from"./vendor.6c36e4e7.js";import{J as g}from"./Job.9a181a6a.js";import{A as S,c as y,B as j,b as V,d as N,e as w}from"./index.236993a1.js";import{_ as C}from"./index.a811416a.js";const _={name:"backUpTable",components:{Job:g},setup(){const l=e(""),t=e(["information_schema","mysql","performance_schema","sys"]),o=e([]),r=e([]),d=e([]),u=e([]),s=e(!1),i=e(0),n=a({jobName:"",jobState:"",dataSourceId:"",page:1,size:10,jobType:0}),c=e([]),b=e([]),m=e(0),h=e(!1),v=a({jobName:"",jobDescribe:"",jobType:0,dataSourceId:"",jobPolicy:""}),g=e(!1),C=e(!1);let _=a({id:0,sourceName:"",sourceType:"",sourceHost:"",sourcePort:"",sourceUser:"",sourcePwd:""});const k=()=>{y().then((e=>{"0"===e.code?o.value=e.result:p.error("获取所有数据源列表失败:"+e.message)}))},x=()=>{k(),j(n).then((e=>{c.value=e.result.records,m.value=e.result.total||50}))};x();return{timer:l,allDataBase:d,dataBase:r,dataSources:o,visible:s,deleteId:i,query:n,tableData:c,jobRecordData:b,pageTotal:m,editVisible:g,viewVisible:C,addVisible:h,form:_,addForm:v,selectDataSource:e=>{S(e).then((e=>{if("0"===e.code){u.value=e.result;for(let e=1;e<=u.value.length;e++){let a=u.value[e-1];d.value.push({key:e,label:a,disabled:!!t.value.includes(a)})}}else p.error("获取所有数据源下所有数据库失败:"+e.message)}))},allDataSource:k,handleAdd:()=>{h.value=!0,k()},handleSearch:()=>{n.page_num=1,x()},handlePageChange:e=>{n.page=e,x()},handleDelete:(e,a)=>{i.value=a.id,f.confirm("确定要删除吗？","提示",{type:"warning"}).then((()=>{V(i.value).then((e=>{"0"===e.code?(p.success("删除数据源成功"),x()):p.error("删除数据源失败"+e.message)})),i.value=0})).catch((()=>{i.value=0}))},handleEdit:(e,a)=>{Object.keys(_).forEach((e=>{_[e]=a[e]})),g.value=!0},handleView:(e,a)=>{N(a.id).then((e=>{"0"===e.code?b.value=e.result:p.error("获取备份任务列表失败:"+e.message)})),l.value=(new Date).getTime(),C.value=!0},saveAdd:()=>{let e={},a=[],l=[];for(let t=1;t<=u.value.length;t++){let e=u.value[t-1];r.value.includes(t)?a.push(e):l.push(e)}e.backUpDataBase=a,e.excludeDataBase=l,v.jobPolicy=JSON.stringify(e),w(v).then((e=>{"0"===e.code?(p.success("创建备份任务成功"),x()):p.error("创建备份任务失败"+e.message)})),h.value=!1},filterType:(e,a)=>a.jobType===e,filterState:(e,a)=>a.jobState===e,getStateTag:e=>"NORMAL"===e?"info":"RUNNING"===e?"warning":"SUCCESS"===e?"success":"FAIL"===e?"danger":"",filterJobResult:(e,a)=>a.jobResult===e,filterJobRecordResult:(e,a)=>a.result===e,jsonStrtoArray:e=>JSON.parse(e),byteToStr:e=>{if(!e)return"";var a=1024;return e<a?e+"B":e<Math.pow(a,2)?(e/a).toFixed(2)+"KB":e<Math.pow(a,3)?(e/Math.pow(a,2)).toFixed(2)+"MB":e<Math.pow(a,4)?(e/Math.pow(a,3)).toFixed(2)+"G":(e/Math.pow(a,4)).toFixed(2)+"T"}}}},k={class:"crumbs"},x=(e=>(h("data-v-438fa8a8"),e=e(),v(),e))((()=>r("i",{class:"el-icon-lx-cascades"},null,-1))),U={class:"container"},D={class:"handle-box"},I={class:"pagination"},F={class:"dialog-footer"};var T=C(_,[["render",function(e,a,p,f,h,v){const g=l("el-breadcrumb-item"),S=l("el-breadcrumb"),y=l("el-option"),j=l("el-select"),V=l("el-input"),N=l("el-button"),w=l("el-table-column"),C=l("el-tag"),_=l("el-table"),T=l("el-pagination"),A=l("el-form-item"),R=l("el-transfer"),q=l("el-form"),B=l("el-dialog"),M=l("Job");return t(),o("div",null,[r("div",k,[d(S,{separator:"/"},{default:u((()=>[d(g,null,{default:u((()=>[x,s("一次性备份任务 ")])),_:1})])),_:1})]),r("div",U,[r("div",D,[d(j,{modelValue:f.query.dataSourceId,"onUpdate:modelValue":a[0]||(a[0]=e=>f.query.dataSourceId=e),placeholder:"数据源",filterable:"",clearable:"",class:"handle-input mr10"},{default:u((()=>[(t(!0),o(i,null,n(f.dataSources,(e=>(t(),c(y,{key:e.id,label:e.sourceName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),d(V,{modelValue:f.query.jobName,"onUpdate:modelValue":a[1]||(a[1]=e=>f.query.jobName=e),placeholder:"任务名称",class:"handle-input mr10"},null,8,["modelValue"]),d(j,{modelValue:f.query.jobState,"onUpdate:modelValue":a[2]||(a[2]=e=>f.query.jobState=e),placeholder:"任务状态",filterable:"",clearable:"",class:"handle-input mr10"},{default:u((()=>[d(y,{key:"NORMAL",label:"正常",value:"NORMAL"}),d(y,{key:"RUNNING",label:"运行中",value:"RUNNING"}),d(y,{key:"SUCCESS",label:"成功",value:"SUCCESS"}),d(y,{key:"FAIL",label:"失败",value:"FAIL"})])),_:1},8,["modelValue"]),d(N,{type:"primary",icon:"el-icon-search",onClick:f.handleSearch},{default:u((()=>[s("搜索")])),_:1},8,["onClick"]),d(N,{type:"primary",icon:"el-icon-plus",onClick:f.handleAdd},{default:u((()=>[s("新增")])),_:1},8,["onClick"])]),d(_,{data:f.tableData,border:"",class:"table",ref:"multipleTable","header-cell-class-name":"table-header"},{default:u((()=>[d(w,{prop:"id",label:"ID",align:"center"}),d(w,{prop:"dataSourceName",label:"数据源"}),d(w,{prop:"jobName",label:"任务名称","show-overflow-tooltip":""}),d(w,{prop:"jobDescribe",label:"描述","show-overflow-tooltip":""}),d(w,{prop:"jobState",label:"任务状态",filters:[{text:"正常",value:"NORMAL"},{text:"运行中",value:"RUNNING"},{text:"成功",value:"SUCCESS"},{text:"失败",value:"FAIL"}],"filter-method":f.filterState,"filter-placement":"bottom-end"},{default:u((e=>[d(C,{type:f.getStateTag(e.row.jobState)},{default:u((()=>[s(b(e.row.jobState),1)])),_:2},1032,["type"])])),_:1},8,["filter-method"]),d(w,{prop:"executeTime",label:"执行时间"}),d(w,{label:"操作",align:"center"},{default:u((e=>[d(N,{icon:"el-icon-view",size:"small",onClick:a=>f.handleView(e.$index,e.row)},null,8,["onClick"])])),_:1})])),_:1},8,["data"]),r("div",I,[d(T,{background:"",layout:"total, prev, pager, next","current-page":f.query.page,"page-size":f.query.size,total:f.pageTotal,onCurrentChange:f.handlePageChange},null,8,["current-page","page-size","total","onCurrentChange"])])]),m(" 新增job任务 "),d(B,{title:"新增一次性任务",modelValue:f.addVisible,"onUpdate:modelValue":a[8]||(a[8]=e=>f.addVisible=e),width:"50%"},{footer:u((()=>[r("span",F,[d(N,{onClick:a[7]||(a[7]=e=>f.addVisible=!1)},{default:u((()=>[s("取 消")])),_:1}),d(N,{type:"primary",onClick:f.saveAdd},{default:u((()=>[s("确 定")])),_:1},8,["onClick"])])])),default:u((()=>[d(q,{"label-width":"100px"},{default:u((()=>[d(A,{label:"任务名称",required:!0},{default:u((()=>[d(V,{modelValue:f.addForm.jobName,"onUpdate:modelValue":a[3]||(a[3]=e=>f.addForm.jobName=e)},null,8,["modelValue"])])),_:1}),d(A,{label:"数据源",required:!0},{default:u((()=>[d(j,{modelValue:f.addForm.dataSourceId,"onUpdate:modelValue":a[4]||(a[4]=e=>f.addForm.dataSourceId=e),placeholder:"请选择",filterable:"",onChange:f.selectDataSource},{default:u((()=>[(t(!0),o(i,null,n(f.dataSources,(e=>(t(),c(y,{key:e.id,label:e.sourceName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","onChange"])])),_:1}),d(A,{label:"数据库"},{default:u((()=>[d(R,{modelValue:f.dataBase,"onUpdate:modelValue":a[5]||(a[5]=e=>f.dataBase=e),data:f.allDataBase,titles:["所有数据库","要备份的数据库"],filterable:""},null,8,["modelValue","data"])])),_:1}),d(A,{label:"描述"},{default:u((()=>[d(V,{modelValue:f.addForm.jobDescribe,"onUpdate:modelValue":a[6]||(a[6]=e=>f.addForm.jobDescribe=e),type:"textarea"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),m(" job执行记录 "),(t(),c(M,{viewVisible:f.viewVisible,"job-record-data":f.jobRecordData,key:f.timer},null,8,["viewVisible","job-record-data"]))])}],["__scopeId","data-v-438fa8a8"]]);export{T as default};
